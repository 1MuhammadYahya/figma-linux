FROM 4tqrgqe5yrgfd/figma-linux-docker-iamge:latest

WORKDIR /usr/src/figma-linux

COPY ./build/installers ./installers

RUN export FIGMA_LINUX_VERSION=$(cat ./installers/version)

ENV DEB_DIR ./figma-linux-$FIGMA_LINUX_VERSION

COPY ./gpg ./

RUN gpg --import ./gpg/pub.key && \
  gpg --import ./gpg/secret.key && \
  gpg -k && \
  mkdir $DEB_DIR && \
  ls -la && \
  cp -rf ./installers/linux-unpacked/* $DEB_DIR && \
  cp -rf ./installers/linux-unpacked/figma-linux.desktop $DEB_DIR/resources && \
  cd ./installers/linux-unpacked/ && \
  tar cJf ../../figma-linux_$FIGMA_LINUX_VERSION.orig.tar.xz ./* && \
  cd ../../$DEB_DIR && \
  echo -e "[ppa-figma]\nfqdn = ppa.launchpad.net\nmethod = sftp\nincoming = ~chrdevs/ubuntu/figma\nlogin = chrdevs\nallow_unsigned_uploads = 1" > /root/.dput.cf

COPY ./scripts/debian ./${DEB_DIR}/debian

RUN cd ${DEB_DIR} && \
  EDITOR=/bin/true dpkg-source -q --commit . patchsetname && \
  debuild -S -sa -p"gpg --batch --passphrase-file ./gpg/passphrase --pinentry-mode loopback" && \
  dput ../figma-linux_${FIGMA_LINUX_VERSION}-1ubuntu0_source.changes
